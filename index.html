<!-- Ná»™i dung giá»‘ng báº£n trÆ°á»›c: khung + style + html layout -->

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

const hkdData = {};
let currentHKD = '';

function removeVN(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/Ä‘/g, "d").replace(/Ä/g, "D").toLowerCase();
}

function groupTextByY(items) {
  const lines = {};
  for (const item of items) {
    const y = Math.round(item.transform[5]);
    const x = item.transform[4];
    if (!lines[y]) lines[y] = [];
    lines[y].push({ x, str: item.str });
  }

  const sortedY = Object.keys(lines).sort((a, b) => b - a);
  return sortedY.map(y => lines[y].sort((a, b) => a.x - b.x).map(t => t.str).join(' '));
}

function parseInvoiceBlocks(lines) {
  const blocks = [];
  let block = [];

  for (const line of lines) {
    if (/^mau so|^ky hieu|^so:|^hoa don gia tri/i.test(line) && block.length) {
      blocks.push(block);
      block = [];
    }
    block.push(line);
  }
  if (block.length) blocks.push(block);
  return blocks;
}

// âœ… Sá»¬A: tÃ¡ch tÃªn ngÆ°á»i mua tá»« dÃ²ng tiáº¿p theo náº¿u cáº§n
function getHKD(block) {
  for (let i = 0; i < block.length; i++) {
    const line = removeVN(block[i]);
    if (/ten nguoi mua/.test(line)) {
      const next = block[i + 1]?.trim() || '';
      if (next && !/ma so thue|dia chi/i.test(removeVN(next))) {
        return next;
      }
    }
  }
  return 'HKD khÃ´ng rÃµ';
}

function getNPP(block) {
  for (let i = 0; i < block.length; i++) {
    const line = removeVN(block[i]);
    if (/ten nguoi ban/.test(line)) {
      const next = block[i + 1]?.trim() || '';
      return next;
    }
  }
  return 'NPP khÃ´ng rÃµ';
}

function extractDataFromBlock(block) {
  const HKD = getHKD(block);
  const NPP = getNPP(block);
  const data = [];

  const start = block.findIndex(l => /hang hoa, dich vu/i.test(removeVN(l)));
  if (start === -1) return { HKD, NPP, data };

  for (let i = start + 1; i < block.length; i++) {
    const line = block[i];
    if (/^tong|^thue|^tong tien|^chu ky/i.test(removeVN(line))) break;

    const parts = line.trim().split(/\s+/);
    if (parts.length < 6) continue;

    const last = parts.slice(-6);
    let name = parts.slice(0, parts.length - 6).join(' ');
    name = name.replace(/^\d+\s*/g, '').replace(/^hang\s*/i, '');

    const slRaw = last[1].replace(',', '.');
    const sl = Number(slRaw);
    // âŒ KHÃ”NG LOáº I Sá» LÆ¯á»¢NG = 0
    if (!Number.isFinite(sl)) continue;

    data.push({
      ten: name,
      dvt: last[0],
      sl: sl,
      gia: parseFloat(last[2].replace(',', '.')),
      ck: parseFloat(last[3].replace(',', '.')),
      thue: last[4],
      tt: parseFloat(last[5].replace(',', '.')),
      loai: 'HÃ ng hÃ³a',
      hkd: HKD,
      npp: NPP
    });
  }

  return { HKD, NPP, data };
}

// pháº§n showTableFor(...) + addRow() + updateTotals() giá»¯ nguyÃªn nhÆ° báº£n trÆ°á»›c

document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const status = document.getElementById('status');
  status.innerText = 'ğŸ“¥ Äang xá»­ lÃ½...';

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  let allLines = [];
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const lines = groupTextByY(content.items);
    allLines.push(...lines);
  }

  const blocks = parseInvoiceBlocks(allLines);

  for (const block of blocks) {
    const parsed = extractDataFromBlock(block);
    if (!parsed.HKD || parsed.data.length === 0) continue;
    if (!hkdData[parsed.HKD]) hkdData[parsed.HKD] = [];
    hkdData[parsed.HKD].push(...parsed.data);
  }

  displayHKDList();
  status.innerText = `âœ… ÄÃ£ xá»­ lÃ½ ${blocks.length} hÃ³a Ä‘Æ¡n / ${Object.keys(hkdData).length} HKD`;
});
</script>